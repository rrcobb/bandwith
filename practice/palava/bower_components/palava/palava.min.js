/*
palava v1.2.0-pre | LGPL | https://github.com/palavatv/palava-client

Copyright (C) 2013 Jan Lelis       jan@signaling.io
Copyright (C) 2013 Marius Melzer   marius@signaling.io
Copyright (C) 2013 Stephan Thamm   thammi@chaossource.net
Copyright (C) 2013 Kilian Ulbrich  kilian@innovailable.eu

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
(function(){}).call(this),function(){this.palava={browser:{}}}.call(this),function(){"object"==typeof module&&"object"==typeof module.exports&&(module.exports=this.palava),this.EventEmitter="object"!=typeof EventEmitter&&"function"==typeof require?require("wolfy87-eventemitter"):EventEmitter,this.$="object"!=typeof $&&"function"==typeof require?require("jquery"):$}.call(this),function(){var t,e;e=this.palava,t=this.$,e.browser.PeerConnection=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,e.browser.IceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,e.browser.SessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,e.browser.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,e.browser.isMozilla=function(){return window.mozRTCPeerConnection?!0:!1},e.browser.isChrome=function(){return/Chrome/i.test(navigator.userAgent)},e.browser.getUserAgent=function(){return e.browser.isMozilla()?"firefox":e.browser.isChrome()?"chrome":"unknown"},e.browser.checkForWebrtcError=function(){var t;try{new e.browser.PeerConnection({iceServers:[]})}catch(r){return t=r}return!(e.browser.PeerConnection&&e.browser.IceCandidate&&e.browser.SessionDescription&&e.browser.getUserMedia)},e.browser.chromeVersion=function(){var t,e,r;return t=/Chrome\/(\d+)/i.exec(navigator.userAgent),t?(r=t[0],e=t[1],parseInt(e)):!1},e.browser.checkForPartialSupport=function(){return e.browser.isChrome()&&e.browser.chromeVersion()<26},e.browser.getConstraints=function(){var t;return t={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}},e.browser.getPeerConnectionOptions=function(){return e.browser.isChrome()?{optional:[{DtlsSrtpKeyAgreement:!0}]}:{}},e.browser.patchSDP=function(t){var r,n,i,o,s,u,a,h,c;if(e.browser.isChrome()&&e.browser.chromeVersion()>=31)return t;for(r=function(){for(c=[],u=33;58>=u;u++)c.push(u);return c}.apply(this).concat(function(){for(h=[],s=60;126>=s;s++)h.push(s);return h}.apply(this)).map(function(t){return String.fromCharCode(t)}),o="",i=a=0;40>a;i=++a)o+=r[Math.floor(Math.random()*r.length)];return n="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+o+"\r\nc=IN",-1===t.sdp.indexOf("a=crypto")&&(t.sdp=t.sdp.replace(/c=IN/g,n)),t},e.browser.registerFullscreen=function(t,e){return t[0].requestFullscreen?t.on(e,function(){return this.requestFullscreen()}):t[0].mozRequestFullScreen?t.on(e,function(){return this.mozRequestFullScreen()}):t[0].webkitRequestFullscreen?t.on(e,function(){return this.webkitRequestFullscreen()}):void 0},e.browser.isMozilla()?(e.browser.attachMediaStream=function(e,r){return r?t(e).prop("mozSrcObject",r):(t(e).each(function(t,e){return e.pause()}),t(e).prop("mozSrcObject",null))},e.browser.fixAudio=function(){}):e.browser.isChrome()&&(e.browser.attachMediaStream=function(e,r){return r?t(e).prop("src",webkitURL.createObjectURL(r)):(t(e).each(function(t,e){return e.pause()}),t(e).prop("src",null))},e.browser.fixAudio=function(e){return"true"!==e.attr("data-peer-muted")?t([200,400,1e3,2e3,4e3,8e3,16e3]).each(function(t,r){return setTimeout(function(){return e.find(".plv-video-mute").click(),e.find(".plv-video-mute").click()},r)}):void 0}),e.browser.attachPeer=function(t,r){var n;return n=function(){return e.browser.attachMediaStream(t,r.getStream()),r.isLocal()&&t.attr("muted",!0),t[0].play()},r.getStream()?n():r.on("stream_ready",function(){return n()})}}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.Gum=function(r){function i(t){this.releaseStream=e(this.releaseStream,this),this.getStream=e(this.getStream,this),this.requestStream=e(this.requestStream,this),this.detectMedia=e(this.detectMedia,this),this.changeConfig=e(this.changeConfig,this),this.config=t||{video:!0,audio:!0},this.stream=null}return n(i,r),i.prototype.changeConfig=function(t){return this.config=t,this.releaseStream(),this.requestStream()},i.prototype.detectMedia=function(){return this.config={video:!1,audio:!1},this.stream&&this.stream.getVideoTracks().length>0&&(this.config.video=!0),this.stream&&this.stream.getAudioTracks().length>0?this.config.audio=!0:void 0},i.prototype.requestStream=function(){return t.browser.getUserMedia.call(navigator,this.config,function(t){return function(e){return t.stream=e,t.detectMedia(),t.emit("stream_ready",t)}}(this),function(t){return function(){return t.emit("stream_error",t)}}(this)),!0},i.prototype.getStream=function(){return this.stream},i.prototype.releaseStream=function(){return this.stream?(this.stream.stop(),this.stream=null,this.emit("stream_released",this),!0):!1},i}(this.EventEmitter)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}};t=this.palava,t.Identity=function(){function r(t){this.getStatus=e(this.getStatus,this),this.getName=e(this.getName,this),this.userMediaConfig=t.userMediaConfig,this.status=t.status||{},this.status.name=t.name}return r.prototype.newUserMedia=function(){return new t.Gum(this.userMediaConfig)},r.prototype.getName=function(){return this.name},r.prototype.getStatus=function(){return this.status},r}()}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.Peer=function(r){function i(r,n){this.isLocal=e(this.isLocal,this),this.isReady=e(this.isReady,this),this.isMuted=e(this.isMuted,this),this.hasAudio=e(this.hasAudio,this);var i;this.id=r,this.status=n||{},(i=this.status).user_agent||(i.user_agent=t.browser.getUserAgent()),this.joinTime=(new Date).getTime()}return n(i,r),i.prototype.hasAudio=function(){return t.browser.checkForPartialSupport()||this.getStream()&&this.getStream().getAudioTracks().length},i.prototype.isMuted=function(){return this.muted?!0:!1},i.prototype.isReady=function(){return this.ready?!0:!1},i.prototype.isLocal=function(){return this.local?!0:!1},i}(this.EventEmitter)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.LocalPeer=function(r){function i(t,r,n){this.leave=e(this.leave,this),this.toggleMute=e(this.toggleMute,this),this.hasAudio=e(this.hasAudio,this),this.updateStatus=e(this.updateStatus,this),this.getStream=e(this.getStream,this),this.setupRoom=e(this.setupRoom,this),this.setupUserMedia=e(this.setupUserMedia,this),this.muted=!0,this.local=!0,i.__super__.constructor.call(this,t,r),this.room=n,this.userMedia=n.userMedia,this.setupRoom(),this.setupUserMedia()}return n(i,r),i.prototype.setupUserMedia=function(){return this.userMedia.on("stream_released",function(t){return function(){return t.ready=!1,t.emit("stream_removed")}}(this)),this.userMedia.on("stream_ready",function(t){return function(e){return t.ready=!0,t.emit("stream_ready",e)}}(this)),this.userMedia.on("stream_error",function(t){return function(e){return t.emit("stream_error",e)}}(this)),this.getStream()?(this.ready=!0,this.emit("stream_ready")):void 0},i.prototype.setupRoom=function(){return this.room.peers[this.id]=this.room.localPeer=this,this.on("update",function(t){return function(){return t.room.emit("peer_update",t)}}(this)),this.on("stream_ready",function(t){return function(){return t.room.emit("peer_stream_ready",t)}}(this)),this.on("stream_removed",function(t){return function(){return t.room.emit("peer_stream_removed",t)}}(this))},i.prototype.getStream=function(){return this.userMedia.getStream()},i.prototype.updateStatus=function(e){var r,n;if(!(e&&e instanceof Object&&0!==Object.keys(e).length))return e;for(r in e)this.status[r]=e[r];return(n=this.status).user_agent||(n.user_agent=t.browser.getUserAgent()),this.room.channel.send({event:"update_status",status:this.status}),this.status},i.prototype.hasAudio=function(){var t;return(t=this.getStream())?t.getAudioTracks().length>0:!1},i.prototype.toggleMute=function(){return this.userMedia.changeConfig({video:this.userMedia.config.video,audio:!this.userMedia.config.audio})},i.prototype.leave=function(){return this.ready=!1,this.emit("left")},i}(t.Peer)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}};t=this.palava,t.Distributor=function(){function t(t,r){null==r&&(r=null),this.send=e(this.send,this),this.on=e(this.on,this),this.channel=t,this.peerId=r}return t.prototype.on=function(t,e){return this.channel.on("message",function(r){return function(n){if(r.peerId){if(n.sender_id===r.peerId&&t===n.event)return e(n)}else if(!n.sender_id&&t===n.event)return e(n)}}(this))},t.prototype.send=function(t){var e;return e=this.peerId?{event:"send_to_peer",peer_id:this.peerId,data:t}:t,this.channel.send(e)},t}()}.call(this),function(){var t,e={}.hasOwnProperty,r=function(t,r){function n(){this.constructor=t}for(var i in r)e.call(r,i)&&(t[i]=r[i]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};t=this.palava,t.DataChannel=function(t){function e(t){this.channel=t,this.channel.onmessage=function(t){return function(e){return t.emit("message",e.data)}}(this),this.channel.onclose=function(t){return function(){return t.emit("close")}}(this),this.channel.onerror=function(t){return function(e){return t.emit("error",e)}}(this),this.sendBuffer=[]}return r(e,t),e.prototype.MAX_BUFFER=1048576,e.prototype.send=function(t,e){return this.sendBuffer.push([t,e]),1===this.sendBuffer.length?this.actualSend():void 0},e.prototype.actualSend=function(){var t,e,r,n;if("open"!==this.channel.readyState)return void console.log("Not sending when not open!");for(;this.sendBuffer.length;){if(this.channel.bufferedAmount>this.MAX_BUFFER)return void setTimeout(this.actualSend.bind(this),1);n=this.sendBuffer[0],e=n[0],t=n[1];try{this.channel.send(e)}catch(i){return r=i,void setTimeout(this.actualSend.bind(this),1)}try{"function"==typeof t&&t()}catch(i){r=i,console.log("Exception in write callback:",r)}this.sendBuffer.shift()}},e}(this.EventEmitter)}.call(this),function(){var t,e,r=function(t,e){return function(){return t.apply(e,arguments)}},n={}.hasOwnProperty,i=function(t,e){function r(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};e=this.palava,t=this.$,e.RemotePeer=function(n){function o(t,e,n,i){this.mozillaCheckAddStream=r(this.mozillaCheckAddStream,this),this.oaError=r(this.oaError,this),this.sdpSender=r(this.sdpSender,this),this.sendMessage=r(this.sendMessage,this),this.sendAnswer=r(this.sendAnswer,this),this.sendOffer=r(this.sendOffer,this),this.setupRoom=r(this.setupRoom,this),this.setupDistributor=r(this.setupDistributor,this),this.setupPeerConnection=r(this.setupPeerConnection,this),this.generateIceOptions=r(this.generateIceOptions,this),this.toggleMute=r(this.toggleMute,this),this.hasAudio=r(this.hasAudio,this),this.getStream=r(this.getStream,this),this.muted=!1,this.local=!1,o.__super__.constructor.call(this,t,e),this.room=n,this.remoteStream=null,this.dataChannels={},this.setupRoom(),this.setupPeerConnection(i),this.setupDistributor(),i&&this.sendOffer()}return i(o,n),o.prototype.getStream=function(){return this.remoteStream},o.prototype.hasAudio=function(){return this.remoteStream&&(e.browser.checkForPartialSupport()||this.remoteStream.getAudioTracks().length)},o.prototype.toggleMute=function(){return this.muted=!this.muted},o.prototype.generateIceOptions=function(){var t;return t=[],this.room.options.stun&&t.push({url:this.room.options.stun}),this.room.options.turn&&t.push({url:this.room.options.turn.url,username:this.room.options.turn.username,credential:this.room.options.turn.password}),{iceServers:t}},o.prototype.setupPeerConnection=function(t){var r,n,i,o,s;if(this.peerConnection=new e.browser.PeerConnection(this.generateIceOptions(),e.browser.getPeerConnectionOptions()),this.peerConnection.onicecandidate=function(t){return function(e){return e.candidate?t.distributor.send({event:"ice_candidate",sdpmlineindex:e.candidate.sdpMLineIndex,sdpmid:e.candidate.sdpMid,candidate:e.candidate.candidate}):void 0}}(this),this.peerConnection.onaddstream=function(t){return function(e){return t.remoteStream=e.stream,t.ready=!0,t.emit("stream_ready")}}(this),this.peerConnection.onremovestream=function(t){return function(){return t.remoteStream=null,t.ready=!1,t.emit("stream_removed")}}(this),this.peerConnection.oniceconnectionstatechange=function(t){return function(e){var r;return r=e.target.iceConnectionState,"failed"===r?t.emit("stream_error"):void 0}}(this),this.room.localPeer.getStream()&&this.peerConnection.addStream(this.room.localPeer.getStream()),null!=this.room.options.dataChannels)if(o=function(t){return function(r){var n,i;return n=r.label,i=new e.DataChannel(r),t.dataChannels[n]=i,t.emit("channel_ready",n,i)}}(this),t){s=this.room.options.dataChannels;for(n in s)i=s[n],r=this.peerConnection.createDataChannel(n,i),r.onopen=function(){return o(this)}}else this.peerConnection.ondatachannel=function(){return function(t){return o(t.channel)}}(this);return this.peerConnection},o.prototype.setupDistributor=function(){return this.distributor=new e.Distributor(this.room.channel,this.id),this.distributor.on("peer_left",function(t){return function(){return t.ready&&(t.remoteStream=null,t.emit("stream_removed"),t.ready=!1),t.peerConnection.close(),t.emit("left")}}(this)),this.distributor.on("ice_candidate",function(t){return function(r){var n;return n=new e.browser.IceCandidate({candidate:r.candidate,sdpMLineIndex:r.sdpmlineindex,sdpMid:r.sdpmid}),t.peerConnection.addIceCandidate(n)}}(this)),this.distributor.on("offer",function(t){return function(r){return t.peerConnection.setRemoteDescription(new e.browser.SessionDescription(r.sdp)),t.emit("offer"),t.sendAnswer()}}(this)),this.distributor.on("answer",function(t){return function(r){return t.peerConnection.setRemoteDescription(new e.browser.SessionDescription(r.sdp)),t.emit("answer")}}(this)),this.distributor.on("peer_updated_status",function(t){return function(e){return t.status=e.status,t.emit("update")}}(this)),this.distributor.on("message",function(t){return function(e){return t.emit("message",e.data)}}(this)),this.distributor},o.prototype.setupRoom=function(){return this.room.peers[this.id]=this,this.on("left",function(t){return function(){return delete t.room.peers[t.id],t.room.emit("peer_left",t)}}(this)),this.on("offer",function(t){return function(){return t.room.emit("peer_offer",t)}}(this)),this.on("answer",function(t){return function(){return t.room.emit("peer_answer",t)}}(this)),this.on("update",function(t){return function(){return t.room.emit("peer_update",t)}}(this)),this.on("stream_ready",function(t){return function(){return t.room.emit("peer_stream_ready",t)}}(this)),this.on("stream_error",function(t){return function(){return t.room.emit("peer_stream_error",t)}}(this)),this.on("stream_removed",function(t){return function(){return t.room.emit("peer_stream_removed",t)}}(this)),this.on("oaerror",function(t){return function(e){return t.room.emit("peer_oaerror",t,e)}}(this)),this.on("channel_ready",function(t){return function(e,r){return t.room.emit("peer_channel_ready",t,e,r)}}(this))},o.prototype.sendOffer=function(){return this.peerConnection.createOffer(this.sdpSender("offer"),this.oaError,e.browser.getConstraints()),this.mozillaCheckAddStream()},o.prototype.sendAnswer=function(){return this.peerConnection.createAnswer(this.sdpSender("answer"),this.oaError,e.browser.getConstraints()),this.mozillaCheckAddStream()},o.prototype.sendMessage=function(t){return this.distributor.send({event:"message",data:t})},o.prototype.sdpSender=function(t){return function(r){return function(n){return n=e.browser.patchSDP(n),r.peerConnection.setLocalDescription(n),r.distributor.send({event:t,sdp:n})}}(this)},o.prototype.oaError=function(t){return this.emit("oaerror",t)},o.prototype.mozillaCheckAddStream=function(){var r;return e.browser.isMozilla()?r=t([100,200,400,1e3,2e3,4e3,8e3,12e3,16e3]).map(function(t){return function(e,n){return setTimeout(function(){var e;return(e=t.peerConnection.remoteStreams&&t.peerConnection.remoteStreams[0]||t.peerConnection.getRemoteStreams()&&t.peerConnection.getRemoteStreams()[0])?(r.each(function(t,e){return clearTimeout(e)}),t.peerConnection.onaddstream({stream:e})):void 0},n)}}(this)):void 0},o}(e.Peer)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.Room=function(r){function i(t,r,n,i){null==i&&(i={}),this.getAllPeers=e(this.getAllPeers,this),this.getRemotePeers=e(this.getRemotePeers,this),this.getLocalPeer=e(this.getLocalPeer,this),this.getPeerById=e(this.getPeerById,this),this.leave=e(this.leave,this),this.join=e(this.join,this),this.setupDistributor=e(this.setupDistributor,this),this.setupOptions=e(this.setupOptions,this),this.setupChannel=e(this.setupChannel,this),this.setupUserMedia=e(this.setupUserMedia,this),this.id=t,this.userMedia=n,this.channel=r,this.peers={},this.options=i,this.setupUserMedia(),this.setupChannel(),this.setupDistributor(),this.setupOptions()}return n(i,r),i.prototype.setupUserMedia=function(){return this.userMedia.on("stream_ready",function(t){return function(e){return t.emit("local_stream_ready",e.stream)}}(this)),this.userMedia.on("stream_error",function(t){return function(e){return t.emit("local_stream_error",e.stream)}}(this)),this.userMedia.on("stream_released",function(t){return function(){return t.emit("local_stream_removed")}}(this))},i.prototype.setupChannel=function(){return this.channel.on("not_reachable",function(t){return function(e){return t.emit("signaling_not_reachable",e)}}(this)),this.channel.on("error",function(t){return function(e){return t.emit("signaling_error",e)}}(this)),this.channel.on("close",function(t){return function(e){return t.emit("signaling_close",e)}}(this))},i.prototype.setupOptions=function(){var t,e;return(t=this.options).joinTimeout||(t.joinTimeout=1e3),(e=this.options).ownStatus||(e.ownStatus={})},i.prototype.setupDistributor=function(){return this.distributor=new t.Distributor(this.channel),this.distributor.on("joined_room",function(e){return function(r){var n,i,o,s,u,a;for(clearTimeout(e.joinCheckTimeout),new t.LocalPeer(r.own_id,e.options.ownStatus,e),a=r.peers,s=0,u=a.length;u>s;s++)o=a[s],i=!t.browser.isChrome(),n=new t.RemotePeer(o.peer_id,o.status,e,i);return e.emit("joined",e)}}(this)),this.distributor.on("new_peer",function(e){return function(r){var n,i;return i="chrome"===r.status.user_agent,n=new t.RemotePeer(r.peer_id,r.status,e,i),e.emit("peer_joined",n)}}(this)),this.distributor.on("error",function(t){return function(e){return t.emit("signaling_error",e.message)}}(this)),this.distributor.on("shutdown",function(t){return function(e){return t.emit("signaling_shutdown",e.seconds)}}(this))},i.prototype.join=function(e){var r,n,i,o;for(null==e&&(e={}),this.joinCheckTimeout=setTimeout(function(t){return function(){return t.emit("join_error","Not able to join room"),t.leave()}}(this),this.options.joinTimeout),i=0,o=e.length;o>i;i++)r=e[i],this.options.ownStatus[r]=e[r];return(n=this.options.ownStatus).user_agent||(n.user_agent=t.browser.getUserAgent()),this.distributor.send({event:"join_room",room_id:this.id,status:this.options.ownStatus})},i.prototype.leave=function(){return this.emit("leave"),this.channel&&this.channel.close(),this.localPeer&&this.localPeer.stream&&this.localPeer.stream.close()},i.prototype.getPeerById=function(t){return this.peers[t]},i.prototype.getLocalPeer=function(){return this.localPeer},i.prototype.getRemotePeers=function(){return this.getAllPeers(!1)},i.prototype.getAllPeers=function(t){var e,r,n,i;null==t&&(t=!0),n=[],i=this.peers;for(e in i)r=i[e],(t||!r.local)&&n.push(r);return n},i}(this.EventEmitter)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.WebSocketChannel=function(t){function r(t){this.close=e(this.close,this),this.send=e(this.send,this),this.setupEvents=e(this.setupEvents,this),this.sendMessages=e(this.sendMessages,this),this.reached=!1,this.socket=new WebSocket(t),this.messagesToDeliverOnConnect=[],this.socket.onopen=function(t){return function(e){return t.setupEvents(),t.sendMessages(),t.emit("open",e)}}(this)}return n(r,t),r.prototype.sendMessages=function(){var t,e,r,n;for(n=this.messagesToDeliverOnConnect,e=0,r=n.length;r>e;e++)t=n[e],this.socket.send(t);return this.messagesToDeliverOnConnect=[]},r.prototype.setupEvents=function(){return this.socket.onmessage=function(t){return function(e){var r;try{return t.emit("message",JSON.parse(e.data))}catch(n){return r=n,t.emit("error_invalid_json",e)}}}(this),this.socket.onerror=function(t){return function(e){return t.emit("error",e)}}(this),this.socket.onclose=function(t){return function(){return t.emit("close")}}(this)},r.prototype.send=function(t){return 1===this.socket.readyState?(0!==this.messagesToDeliverOnConnect.length&&this.sendMessages(),this.socket.send(JSON.stringify(t))):this.socket.readyState>1?this.emit("not_reachable",this.serverAddress):(0===this.messagesToDeliverOnConnect.length&&setTimeout(function(t){return function(){return 1!==t.socket.readyState?(t.close(),t.emit("not_reachable",t.serverAddress)):void 0}}(this),5e3),this.messagesToDeliverOnConnect.push(JSON.stringify(t)))},r.prototype.close=function(){return this.socket.close()},r}(this.EventEmitter)}.call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t=this.palava,t.Session=function(r){function i(t){this.destroy=e(this.destroy,this),this.setupRoom=e(this.setupRoom,this),this.getRoom=e(this.getRoom,this),this.getUserMedia=e(this.getUserMedia,this),this.getChannel=e(this.getChannel,this),this.checkRequirements=e(this.checkRequirements,this),this.assignOptions=e(this.assignOptions,this),this.init=e(this.init,this),this.channel=null,this.userMedia=null,this.roomId=null,this.roomOptions={},this.assignOptions(t)}return n(i,r),i.prototype.init=function(t){return this.assignOptions(t),this.checkRequirements()?(this.setupRoom(),this.userMedia.requestStream()):void 0},i.prototype.assignOptions=function(e){return this.roomId=e.roomId||this.roomId,e.channel?this.channel=e.channel:e.web_socket_channel&&(this.channel=new t.WebSocketChannel(e.web_socket_channel)),e.identity&&(this.userMedia=e.identity.newUserMedia(),this.roomOptions.ownStatus=e.identity.getStatus()),e.dataChannels&&(this.roomOptions.dataChannels=e.dataChannels),e.options?(this.roomOptions.stun=e.options.stun||this.roomOptions.stun,this.roomOptions.turn=e.options.turn||this.roomOptions.turn,this.roomOptions.joinTimeout=e.options.joinTimeout||this.roomOptions.joinTimeout):void 0},i.prototype.checkRequirements=function(){var e;return this.channel?this.userMedia?this.roomId?this.roomOptions.stun?(e=t.browser.checkForWebrtcError())?(this.emit("webrtc_no_support","WebRTC is not supported by your browser",e),!1):t.browser.checkForPartialSupport()?(this.emit("webrtc_partial_support"),!0):!0:(this.emit("argument_error","no stun server given"),!1):(this.emit("argument_error","no room id given"),!1):(this.emit("argument_error","no user media given"),!1):(this.emit("argument_error","no channel given"),!1)},i.prototype.getChannel=function(){return this.channel},i.prototype.getUserMedia=function(){return this.userMedia},i.prototype.getRoom=function(){return this.room},i.prototype.setupRoom=function(){return this.room=new t.Room(this.roomId,this.channel,this.userMedia,this.roomOptions),this.room.on("local_stream_ready",function(t){return function(e){return t.emit("local_stream_ready",e)}}(this)),this.room.on("local_stream_error",function(t){return function(){return t.emit("local_stream_error")}}(this)),this.room.on("local_stream_removed",function(t){return function(){return t.emit("local_stream_removed")}}(this)),this.room.on("join_error",function(t){return function(e){return t.emit("room_join_error",t.room,e)}}(this)),this.room.on("full",function(t){return function(){return t.emit("room_full",t.room)}}(this)),this.room.on("joined",function(t){return function(){return t.emit("room_joined",t.room)}}(this)),this.room.on("peer_joined",function(t){return function(e){return t.emit("peer_joined",e)}}(this)),this.room.on("peer_offer",function(t){return function(e){return t.emit("peer_offer",e)}}(this)),this.room.on("peer_answer",function(t){return function(e){return t.emit("peer_answer",e)}}(this)),this.room.on("peer_update",function(t){return function(e){return t.emit("peer_update",e)}}(this)),this.room.on("peer_stream_ready",function(t){return function(e){return t.emit("peer_stream_ready",e)}}(this)),this.room.on("peer_stream_error",function(t){return function(e){return t.emit("peer_stream_error",e)}}(this)),this.room.on("peer_stream_removed",function(t){return function(e){return t.emit("peer_stream_removed",e)}}(this)),this.room.on("peer_left",function(t){return function(e){return t.emit("peer_left",e)}}(this)),this.room.on("peer_channel_ready",function(t){return function(e,r,n){return t.emit("peer_channel_ready",e,r,n)}}(this)),this.room.on("signaling_shutdown",function(t){return function(e){return t.emit("signaling_shutdown",e)}}(this)),this.room.on("signaling_close",function(t){return function(e){return t.emit("signaling_close",e)}}(this)),this.room.on("signaling_error",function(t){return function(e){return t.emit("signaling_error",e)}}(this)),this.room.on("signaling_not_reachable",function(t){return function(e){return t.emit("signaling_not_reachable",e)}}(this)),!0},i.prototype.destroy=function(){return this.emit("session_before_destroy"),this.room&&this.room.leave(),this.channel&&this.channel.close(),this.userMedia&&this.userMedia.releaseStream(),this.emit("session_after_destroy")},i}(this.EventEmitter)}.call(this),function(){var t;t=this.palava,t.PROTOCOL_NAME="palava",t.PROTOCOL_VERSION="1.0.0",t.protocol_identifier=function(){return t.PROTOCOL_NAME="palava.1.0"}}.call(this);